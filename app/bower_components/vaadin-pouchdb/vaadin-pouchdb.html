<html><head><script src="../pouchdb/dist/pouchdb.js"></script>

<link rel="import" href="../polymer/polymer.html">

<script>Polymer({is:"vaadin-pouchdb",properties:{dbname:{type:String,observer:"_dbnameChanged"},live:{type:Boolean,value:!0},remote:{type:String,value:null,observer:"_remoteChanged"},index:{type:String,observer:"_indexChanged"},descending:{type:Boolean},attachments:{type:Object,notify:!0},data:{type:Array,notify:!0,value:function(){return[]}},status:{type:String,notify:!0}},_indexes:[],_db:null,_remotedb:null,_oldname:null,_synchandler:null,_changesHandler:null,_query:null,getAttachment:function(n,e){return this._db.getAttachment(n,e)},_dbnameChanged:function(){this.cancelChanges(),this.close(),this.dbname&&(this._db=new PouchDB(this.dbname))},_remoteChanged:function(){this.cancelSync(),this.remote&&this.sync().on("change",function(n){n&&(n.changes&&n.changes.array||n.change&&n.change.docs).length>1&&(this.cancelSync(),this.sync())}.bind(this))},close:function(n){this._db&&(n?this._db.destroy():this._db.close(),this._db=null)},then:function(){return this._db},info:function(n,e,t){return this._db.changes({since:n.update_seq,onError:t,onChange:e,continuous:!0})},post:function(n){return this._db.post(n)},put:function(n){return this._db.put(n)},save:function(n){return n._id?this._db.put(n):this._db.post(n)},remove:function(n){return this._db.remove(n)},changes:function(n,e){return this._changesHandler=this._db.changes(e||{since:"now",live:!0,include_docs:!0}).on("change",function(e){n(e.doc)}),this._changesHandler},allDocs:function(){return this.query()},query:function(n,e){return e=e||{include_docs:!0,descending:this.descending},n=n||this._indexes&&this._indexes[0],this.status="querying",(this._query=this._query||(n?this._db.query(n,e):this._db.allDocs(e))).then(function(n){n.rows&&(this.data=n.rows.map(function(n){return n.doc})),this.status=void 0,this._query=null}.bind(this))},_indexChanged:function(){this._indexes=this.index&&this.index.split(/[ *, *]/)||[];for(var n=0;n<this._indexes.length;n++)this.createIndex(this._indexes[n])},createIndex:function(n){var e={};e[n]={map:"function(doc){if(doc."+n+") emit(doc."+n+")}"};var t={_id:"_design/"+n,views:e};this._db.put(t).then(function(){return this._db.query(n,{stale:"update_after"})})["catch"](function(n){if("conflict"!=n.name)throw n})},sync:function(n,e,t){if(!this.remote||this._synchandler)return this._synchandler;var i=t||{timeout:0};this.live&&(i.live=i.retry=!0);var s=this._db.sync(this.remote,i);return s.on("paused",function(){this.status=void 0}.bind(this)).on("active",function(){this.status="syncing"}.bind(this)),n&&s.on("change",n).on("paused",n).on("active",n),e&&s.on("error",e),this._synchandler=this.live?s:null,s},cancelSync:function(){this._synchandler&&(this._synchandler.cancel(),this._synchandler=null)},cancelChanges:function(){this._changesHandler&&(this._changesHandler.cancel(),this._changesHandler=null)}});</script>

<script>Polymer.Vaadin=Polymer.Vaadin||{},Polymer.Vaadin.DbPromise={then:function(e){},on:function(e,t){}},Polymer.Vaadin.DbResp={properties:{rows:{type:Array},total_rows:{type:Number},offset:{type:Number}}},Polymer.Vaadin.DbRow={properties:{doc:{type:Object},_id:{type:String}}},Polymer.Vaadin.Conf={properties:{key:{type:String},keys:{type:Array},startkey:{type:String},endkey:{type:String},limit:{type:Number},descending:{type:Boolean},skip:{type:Number},group:{type:Number},group_level:{type:Number},reduce:{type:Boolean},include_docs:{type:Boolean},inclusive_end:{type:Boolean},update_seq:{type:Boolean}}};</script>
</head><body></body></html>