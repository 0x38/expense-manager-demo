<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../scripts/accounting-js.html">
<link rel="import" href="../scripts/moment-js.html">

<dom-module id="expense-editor">
  <template>
    <style>
      #dialog {
        display: block;
        padding: 16px 32px 64px 32px;
        border: 1px solid #ccc;
        position: absolute;
        top: 0;
        margin: 0;
        width: 80vw;
        background: var(--primary-background-color);
        max-height: 100vh;
        overflow: visible;
      }
      
      .main-layout {
        display: flex;
        flex-direction: row;
      }
      
      .flex {
        flex: 1;
      }
      
      .form {
        flex: 2;
      }
      
      .buttons-layout {
        display: flex;
        flex-direction: row;
        margin-top: 16px;
      }
      
      .buttons-layout paper-button {
        width: 150px;
      }
      
      .save-button {
        background: var(--accent-color);
        color: var(--text-primary-color);
      }
      
      .cancel-button {
        color: var(--accent-color);
      }
      
      h2 {
        font-size: 2em;
        font-weight: 300;
      }
      
      .receipt {
        flex: 3;
        margin-left: 24px;
        min-height: 64px;
        max-width: 400px;
      }
      
      .receipt .receipt-wrapper {
        max-width: 100%;
        display: block;
        margin: 20px auto;
        max-height: 400px;
        overflow-y: scroll;
      }
      
      .receipt-wrapper img {
        width: 100%;
      }
      
      .receipt img[hidden] {
        display: none;
      }
      
      paper-button[hidden] {
        display: none;
      }
      
      #error {
        color: red;
      }
      
      :host > .wrapper {
        height: 100%;
        width: 100%;
        padding: 0;
      }
      
      .close-button {
        color: var(--accent-color);
      }
      
      form::content label {
        font-weight: bold !important;
        color: #999 !important;
      }
      
      .wrapper {
        display: flex;
      }
      
      @media (min-width: 900px) {
        .wrapper {
          flex-direction: row;
        }
      }
      
      @media (max-width: 900px) {
        .receipt {
          margin: 24px 0 0 0;
        }
        .wrapper {
          flex-direction: column;
        }
        .receipt {
          width: 100%;
          margin: 40px auto;
        }
        .receipt .receipt-wrapper {
          max-height: inherit;
        }
        #dialog {
          width: 100vw;
          min-height: 100vh;
          padding: 0 0 60px 0;
          overflow-y: scroll;
        }
      }
    </style>
    <iron-media-query query="(min-height: 900px)" query-matches="{{tallWindow}}"></iron-media-query>
    <paper-dialog id="dialog" modal no-cancel-on-esc-key="false">
      <div class="main-layout">
        <h2>{{caption}}</h2>
        <span class="flex"></span>
        <paper-icon-button icon="close" on-tap="close" class="close-button self-start"></paper-icon-button>
      </div>

      <div class="wrapper">
        <div class="form">
          <form is="iron-form" id="form">
            <iron-a11y-keys keys="enter" on-keys-pressed="_save"></iron-a11y-keys>
            <paper-input name="merchant" id="merchant" value="{{expense.merchant}}" label="Merchant" required error-message="Merchant name required" autofocus="[[tallWindow]]"></paper-input>
            <paper-input name="total" id="total" value="{{expense.total}}" type="number" label="Total" required step="any">
              <div prefix>$</div>
            </paper-input>

            <vaadin-date-picker label="Date" value="{{expense.date}}" id="date" name="date" required></vaadin-date-picker>
            <paper-textarea id="comment" name="comment" label="Comment" value="{{expense.comment}}"></paper-textarea>
          </form>
        </div>
        <div class="receipt">
          <vaadin-upload id="upload" accept="image/*" max-files="1" on-upload-before="_handleUpload" required>
            <div class="file-list">
              <div class="receipt-wrapper">
                <img src$="[[_receiptURL]]" alt="Receipt" hidden$="[[!_showReceipt(expense._attachments.*)]]">
              </div>
            </div>
          </vaadin-upload>
        </div>
      </div>
      <div class="buttons-layout">
        <paper-button raised on-tap="_save" class="save-button">Save</paper-button>
        <paper-button on-tap="close" class="cancel-button">Cancel</paper-button>
        <paper-button on-tap="_delete" id="delete" class="delete-button">Delete
        </paper-button>
      </div>
      <span id="error" hidden$="[[!errorMessage]]">{{errorText}}</span>
    </paper-dialog>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'expense-editor',

        properties: {
          service: Object,
          expense: {
            type: Object,
            notify: true,
            value: function() {
              return {};
            }
          },
          caption: {
            type: String,
            computed: '_getCaption(expense)'
          },
          errorText: String,
          attachments: Object,
          _receiptURL: {
            type: String,
            notify: true,
            value: 'images/default-receipt.png'
          }
        },

        observers: ['_updateReceiptURL(expense._attachments.*)'],



        ready: function() {
          this.$.upload.i18n.dropFiles.one = 'Drop receipt here...';
          this.$.upload.i18n.addFiles.one = 'Select receipt';
        },

        _getCaption: function(expense) {
          if (expense._id) {
            return 'Edit Expense';
          } else {
            return 'Add Expense';
          }
        },

        _showReceipt: function() {
          return this.expense._id ||
            (this.expense._attachments && this.expense._attachments.receipt);
        },

        _updateReceiptURL: function() {
          var _this = this;
          if (this.expense._attachments && this.expense._attachments.receipt) {
            if (this.expense._attachments.receipt.data instanceof File) {
              _this._receiptURL = URL.createObjectURL(this.expense._attachments.receipt.data);
            } else {
              this.attachments.getAttachment(this.expense._id, 'receipt')
                .then(function(blob) {
                  _this._receiptURL = URL.createObjectURL(blob);
                })
                .catch(function(err) {
                  console.log(err);
                });
            }
          } else {
            this._receiptURL = 'images/default-receipt.png';
          }
        },

        listeners: {
          'iron-form-invalid': '_formInvalid'
        },

        _formInvalid: function(e) {
          console.log(e);
        },
        _handleUpload: function(e) {
          var file = e.detail.file;
          if (file) {
            if (!this.expense._attachments) {
              this.expense._attachments = {};
            }
            this.set('expense._attachments.receipt', {
              type: file.type,
              data: file
            });
          }
          this.$.upload.files = [];
          e.preventDefault();
        },

        _save: function() {
          this.$.error.innerText = '';
          var form = this.$.form;
          if (form.validate()) {
            this.expense.total = parseFloat(this.expense.total);
            this.fire('expense-saved', this.expense);
          } else {
            console.log('Form validation failed');
            if (!this.tallWindow) {
              // iron-form doesn't seem to have a way to get invalid fields, so just focusing first for now
              this.$.merchant.focus();
            }
            this.errorText = 'Please fill all required fields';
          }
        },

        open: function(expense) {

          // Create a copy of the expense to be edited so we don't automatically flush changes to db
          this.expense = JSON.parse(JSON.stringify(expense));
          // File objects don't survive the JSON dance, so copy that over manually
          if (expense._attachments) {
            this.set('expense._attachments', expense._attachments);
          }

          this.$.upload.files = [];

          if (!expense.status) {
            this.expense.status = 'new';
          }

          if (expense.total) {
            this.$.total.value = expense.total.toFixed(2);
          }

          this.$.delete.hidden = !(this.expense._id && this.expense.status === 'new');
          this.$.dialog.open();

          // Ensure that the scroll is returned to top on mobile
          this.async(function() {
            this.$.dialog.scrollTop = 0;
          });

        },

        close: function() {
          var _this = this;
          this.async(function() {
            // Prevent tap from leaking through to underlying page
            _this.$.dialog.close();
          }, 10);

        },

        _delete: function() {
          this.fire('delete-expense', this.expense);
        }
      });
    })();
  </script>
</dom-module>