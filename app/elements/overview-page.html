<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/carbon-route/carbon-route.html">
<link rel="import" href="../bower_components/carbon-route/carbon-location.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="expense-editor.html">
<link rel="import" href="info-dialog.html">
<link rel="import" href="content-panel.html">
<link rel="import" href="filters-toolbar.html">
<link rel="import" href="pouch-db.html">
<link rel="import" href="../scripts/moment-js.html">

<dom-module id="overview-page">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-toolbar {
        background: var(--dark-primary-color);
      }

      paper-toolbar h1 {
        font-weight: 300;
      }

      paper-toolbar .logo {
        color: var(--default-primary-color);
        margin-left: 16px;
      }

      .flex {
        flex: 1;
      }

      .content {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        display: flex;
        flex-direction: column;
      }

      #content-panel {
        flex: 1;
      }

      #sync {
        margin-left: 8px;
      }

      #sync[hidden] {
        display: none;
      }

      .logout-button,
      .about-button {
        font-size: 14px;
        color: var(--default-primary-color);
      }

      @media (max-width: 600px) {
        paper-toolbar h1 {
          font-size: 1em;
        }
      }
    </style>
    <!-- Update location and db-name to match your remote DB-->
    <!-- Remove the location attribute if you do not want to sync to a remote DB-->
    <!-- <pouch-db db-name="expenses" data="{{expenses}}" location="http://localhost:5984" status="{{status}}" id="db" attachments="{{attachments}}" init="[[init]]"></pouch-db> -->

    <!--  Online demo DB -->
    <pouch-db db-name="{{dbName}}" location="{{dbLocation}}" data="{{expenses}}" status="{{status}}" id="db" attachments="{{attachments}}"></pouch-db>

    <carbon-location route="{{route}}" use-hash-as-path></carbon-location>

    <carbon-route route="{{route}}" pattern="/:dbId" data="{{routeData}}" tail="{{subroute}}">
    </carbon-route>

    <iron-ajax id="ajax" handle-as="json" on-response="_handleBackendResponse"></iron-ajax>


    <paper-header-panel>
      <paper-toolbar>
        <h1>Expense Manager</h1>
        <iron-icon id="logo" class="logo" src="../images/app-icon.svg"></iron-icon>

        <iron-icon id="sync" icon="notification:sync" hidden$="[[_hideSyncIcon(status)]]"></iron-icon>

        <span class="flex"></span>

        <paper-button on-tap="_showAbout" class="about-button">Info</paper-button>
        <paper-button on-tap="_logout" class="logout-button">Logout</paper-button>
      </paper-toolbar>

      <div class="content">
        <filters-toolbar id="filters-toolbar" merchants="[[merchants]]" filters="{{filters}}" expenses="[[expenses]]"></filters-toolbar>
        <content-panel id="content-panel" filters="{{filters}}" expenses="[[expenses]]"></content-panel>
      </div>

    </paper-header-panel>

    <expense-editor id="expenseEditor" merchants="[[merchants]]" attachments="[[attachments]]" route="{{subroute}}"></expense-editor>
    <paper-toast id="saveNotification"></paper-toast>
    <info-dialog id="info"></info-dialog>
    <iron-localstorage name="expense-manager-db-id" value="{{dbId}}" on-iron-localstorage-load="_setupRemoteDB" on-iron-localstorage-load-empty="_setupRemoteDB"></iron-localstorage>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'overview-page',

        properties: {
          route: Object,
          routeData: Object,
          dbName: String,
          dbId: String,
          dbLocation: String,
          _showInfo: Boolean,
          loggedIn: {
            type: Boolean,
            notify: true,
            observer: '_loginStateChanged'
          },
          status: String,
          expenses: Array,
          merchants: Array,
          attachments: Object,
          filters: {
            type: Object,
            value: function() {
              return {
                start: '',
                end: '',
                merchant: ''
              };
            },

            notify: true
          },
          animationConfig: {
            value: function() {
              return {
                'entry': [{
                  name: 'fade-in-animation',
                  node: this
                }],
                'exit': {
                  name: 'fade-out-animation',
                  node: this
                }
              };
            }
          }
        },

        listeners: {
          'edit-expense': '_editExpense',
          'expenses-updated': '_expensesUpdated',
          'expense-saved': '_saveExpense',
          'delete-expense': '_deleteExpense'
        },

        observers: [
          '_showInfoDialog(loggedIn, _showInfo)',
          '_getUniqueMerchants(expenses.*)',
        ],

        _showInfoDialog: function() {
          if (this.loggedIn && this._showInfo) {
            var self = this;
            this.async(function() {
              self.$.info.open();
              self._showInfo = false;
            }, 1000);
          }
        },

        _getUniqueMerchants: function() {
          if (this.expenses) {
            this.merchants = this.expenses.map(function(e) {
              return e.merchant;
            }).filter(function(val, index, self) {
              return self.indexOf(val) === index;
            });
          }
        },

        _setupRemoteDB: function() {
          if (this.routeData && this.routeData.dbId) {
            console.log('Using DB identifier in URL.');
            this.dbName = 'db_' + this.routeData.dbId;
            this.$.ajax.url = 'https://expense-manager.demo.vaadin.com/api/db/' + this.routeData.dbId;
          } else if (this.dbId) {
            this.dbName = 'db_' + this.dbId;
            console.log('Using DB identifier in localstorage.');
            this.$.ajax.url = 'https://expense-manager.demo.vaadin.com/api/db/' + this.dbId;
          } else {
            console.log('Creating new DB');
            this.$.ajax.url = 'https://expense-manager.demo.vaadin.com/api/create';
          }
          this.$.ajax.generateRequest();
        },

        _handleBackendResponse: function(evt) {
          var response = evt.detail.response;
          console.log('Backend response: ', response);
          if (response) {
            //jscs:disable requireCamelCaseOrUpperCaseIdentifiers
            if (response.couchdb_base_url !== this.dbLocation) {
              this.dbLocation = response.couchdb_base_url;
            }
            if (response.couchdb_db_name !== this.dbName) {
              this.dbName = response.couchdb_db_name;
            }
            this.dbId = response.backend_db_id;

            // this.dbLocation = 'https://vaadin-expense-manager.cloudant.com/';
            // this.dbName = 'e6359be';
            this.set('route.path', '/' + this.dbId);
            if (response.new_db) {
              this._showInfo = true;
            }
          }
        },

        behaviors: [Polymer.NeonAnimatableBehavior],

        _editExpense: function(evt) {
          var editor = this.$.expenseEditor;
          editor.open(evt.detail);
        },

        _hideSyncIcon: function() {
          return this.status !== 'syncing';
        },

        _saveExpense: function(evt) {
          var expense = evt.detail;

          this.$.db.save(expense);
          this.fire('expenses-updated');
        },
        _deleteExpense: function(evt) {
          var expense = evt.detail;
          this.$.db.remove(expense);
          this.fire('expenses-updated', {
            reason: 'deleted'
          });
        },
        _expensesUpdated: function(evt) {
          this.$.expenseEditor.close();
          if (evt.detail.reason === 'deleted') {
            this.$.saveNotification.text = 'Expense was deleted';
          } else {
            this.$.saveNotification.text = 'Expense was saved';
          }
          this.$.saveNotification.show();
        },

        _logout: function() {
          this.loggedIn = false;
          this.dbId = null;
          this.dbName = null;
          this.set('route.path', '');
        },

        _showAbout: function() {
          this.$.info.open();
        },

        _loginStateChanged: function(newValue, oldValue) {
          if (oldValue === false && newValue === true) {
            this._setupRemoteDB();
          }
        }
      });
    })();
  </script>
</dom-module>
