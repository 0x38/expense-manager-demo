<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="search-filters.html">
<link rel="import" href="../scripts/accounting-js.html">

<dom-module id="filters-toolbar">
  <template>
    <style>
      :host {
        display: flex;
        position: relative;
      }

      #filters {
        flex: 1;
        border-right: 1px solid #ddd;
      }

      #toolbar {
        background: var(--default-primary-color);
        display: flex;
        align-items: center;
      }

      #total {
        width: 300px;
        color: var(--text-primary-color);
        box-sizing: border-box;
        font-weight: 500;
        font-size: 18px;
        line-height: 1.4;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #total .sum {
        font-size: 32px;
        font-weight: 200;
      }

      #filters-toggle {
        position: absolute;
        top: 4px;
        right: 16px;
        display: none;
      }

      #filters-toggle .count {
        width: 0;
        height: 0;
        line-height: 28px;
        overflow: hidden;
        text-align: center;
        border-radius: 50%;
        background: var(--dark-primary-color);
        color: var(--primary-color);
        font-weight: 600;
        transform: scale(0);
        transition: all 400ms;
      }

      #filters-toggle .count[has-filters] {
        width: 28px;
        height: 28px;
        transform: scale(1);
      }

      #filters-caption {
        display: none;
      }

      #buttons {
        display: none;
        justify-content: flex-end;
        margin-right: 16px;
      }

      #done-button {
        background: var(--accent-color);
        color: var(--text-primary-color);
      }

      #clear-button {
        color: var(--accent-color);
      }

      @media (max-width: 900px) {
        :host {
          flex-direction: column-reverse;
        }
        #filters-toggle {
          display: flex;
          align-items: center;
          cursor: pointer;
        }
        #filters-toggle span {
          margin-right: 4px;
        }
        #toolbar {
          height: 48px;
          padding: 0 16px;
          flex-shrink: 0;
        }
        #total {
          width: 100%;
          display: flex;
          flex-direction: row;
          justify-content: flex-start;
          align-items: center;
        }
        #total .sum {
          font-size: inherit;
          margin-left: 8px;
        }
        #filters {
          max-height: 0;
          overflow: hidden;
          transition: max-height 400ms;
        }
        :host([expanded]) #filters {
          max-height: 500px;
        }
        :host([expanded]) #filters-caption {
          display: block;
          padding: 0;
          margin: 16px;
          font-size: 16px;
          font-weight: 400;
        }
        :host([expanded]) #buttons {
          display: flex;
          margin-bottom: 32px;
        }
      }
    </style>
    <search-filters filters="{{filters}}" merchants="[[merchants]]" id="filters">
      <div id="buttons">
        <paper-button id="clear-button" on-tap="_clearFilters">Clear filters</paper-button>
        <paper-button id="done-button" on-tap="_hideFilters" raised>Done</paper-button>
      </div>
    </search-filters>

    <div id="toolbar">
      <div id="total">
        <span>Total</span>
        <span class="sum">[[totalOwed]]</span>
      </div>

      <div id="filters-toggle" on-tap="_toggleFilters">
        <span>Filters</span>
        <div class="count" has-filters$="[[_hasFilters(appliedFilters)]]">[[appliedFilters]]</div>
        <paper-icon-button icon="filter-list"></paper-icon-button>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'filters-toolbar',
      properties: {
        filters: Object,
        expenses: Array,
        totalOwed: Number,
        merchants: Array,
        expanded: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        appliedFilters: Number
      },

      observers: [
        '_calculateTotal(expenses.*)',
        '_getUniqueMerchants(expenses.*)',
        '_calculateNumFilters(filters.*)'
      ],

      _calculateTotal: function() {
        if (this.expenses) {
          var total = this.expenses.filter(function(exp) {
              return exp.status === 'new';
            }).map(function(exp) {
              return exp.total;
            })
            .reduce(function(a, b) {
              return a + b;
            }, 0);

          this.totalOwed = accounting.formatMoney(total);
        }
      },

      _hasFilters: function(appliedFilters) {
        return appliedFilters > 0;
      },

      _calculateNumFilters: function() {
        var numFilters = 0;
        for (var f in this.filters) {
          if (this.filters.hasOwnProperty(f)) {
            var filter = this.filters[f];
            if (filter) {
              if (Array.isArray(filter)) {
                numFilters += filter.length;
              } else {
                numFilters++;
              }
            }
          }
        }

        this.appliedFilters = numFilters ? numFilters : '';
      },

      _getUniqueMerchants: function() {
        if (this.expenses) {
          this.merchants = this.expenses.map(function(e) {
            return e.merchant;
          }).filter(function(val, index, self) {
            return self.indexOf(val) === index;
          });
        }
      },

      _toggleFilters: function() {
        this.expanded = !this.expanded;
      },

      _hideFilters: function() {
        // add delay or tap will go through and hit grid
        this.async(function() {
          this.expanded = false;
        }, 100);

      },

      _clearFilters: function() {
        this.set('filters.start', '');
        this.set('filters.end', '');
        this.set('filters.merchant', '');
        this.set('filters.status', []);
        this._hideFilters();
      }
    });
  </script>
</dom-module>
