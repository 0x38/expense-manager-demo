<link rel="import" href="../scripts/pouchdb.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<dom-module id="pouch-db">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <paper-toast id="notification"></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'pouch-db',
      properties: {
        dbName: String,
        location: String,
        data: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },
        attachments: {
          type: Object,
          notify: true
        },
        _localDB: Object,
        _remoteDB: Object,
        _syncHandler: Object,
        _localInited: Boolean,
        /**
         * Staus of our DB, can be one of:
         * ['initializing', 'local_connected', 'remote_connected',
         *  'initializing_data', 'waiting', 'syncing', 'shutdown']
         */
        status: {
          type: String,
          notify: true,
          observer: '_stateChangeObserver'
        }
      },

      observers: ['_setupLocalDB(dbName)', '_setupRemoteDB(dbName, location, _localInited)'],

      ready: function() {
        this.attachments = {
          getAttachment: this._getAttachment.bind(this)
        };
      },

      _setupLocalDB: function() {
        // May get initialized to null from localstorage
        if (this.dbName) {
          console.log('Setting up local db ' + this.dbName);
          this._localDB = new PouchDB(this.dbName, {
            size: 25 // 50MB is max for mobile Safari
          });
          this._localDB.on('created', function() {
            this._localInited = true;
          }.bind(this));
          this._update();
          this.status = 'local_connected';
        }
      },

      _setupRemoteDB: function() {
        if (this.dbName) {
          console.log('Setting up remote db. dbName: ' + this.dbName + ', location: ' + this.location + ', local initialized:' + this._localInited);
          this.location = this.location.indexOf('/', this.location.length - 1) === -1 ?
            this.location + '/' : this.location;

          var dbURL = this.location + this.dbName;
          console.log('DB URL: ' + dbURL);
          this._remoteDB = new PouchDB(dbURL);
          this._remoteDB.on('created', function() {
            console.log('Connected to remote DB.');
            this._setupSync();
          }.bind(this));
        }
      },

      _setupSync: function() {
        console.log('Setting up sync.');
        this._syncHandler = this._localDB.sync(this._remoteDB, {
          live: true,
          retry: true
        }).on('change', function() {
          this._update();
        }.bind(this)).on('paused', function(err) {
          // TODO: Figure out why PouchDB calls this several times before sync is actually finished
          this.debounce('sync-finished', function() {
            this.status = 'waiting';
          }.bind(this), 200);
          if (err) {
            console.log('pouch-db sync failed', err);
          }
        }.bind(this)).on('active', function() {
          this.status = 'syncing';
        }.bind(this)).on('error', function(err) {
          console.log(err);
        });

        this._syncHandler.on('complete', function() {
          this.status = 'shutdown';
          console.log('DB sync successfully shut down.');
        }.bind(this));
      },

      _stateChangeObserver: function(newState, oldState) {
        console.log('pouch-db state changed from ' + oldState + ' to ' + newState);
      },

      detached: function() {
        if (this._syncHandler) {
          this._syncHandler.cancel();
        }
      },

      save: function(doc) {
        if (!doc._id) {
          doc._id = new Date().toJSON();
        }

        this._localDB.put(doc).then(function() {
            this._update();
          }.bind(this))
          .catch(function(err) {
            if (err.name !== 'not_found') {
              throw err;
            }
            return this.localDB.put(doc);
          }.bind(this));
      },

      remove: function(doc) {
        var db = this._localDB;
        db.get(doc._id)
          .then(function(_doc) {
            return db.remove(_doc);
          })
          .then(function() {
            this._update();
          }.bind(this))
          .catch(function(err) {
            console.log(err);
          });
      },

      _getAttachment: function(docId, attachmentName) {
        return this._localDB.getAttachment(docId, attachmentName);
      },

      // Always updating entire array to keep demo code simple.
      // You should probably not do this in a real app (especially if you have a lot of data)
      _update: function() {
        // PouchDB sends out one change event per doc for bulk operations, wait until things
        // settle down before updating.
        this.debounce('update-docs', function() {
          this._localDB.allDocs({
            // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
            include_docs: true,
            descending: true
          }).then(function(result) {
            if (result.rows && result.rows.length > 0) {
              this.data = result.rows.map(function(row) {
                return row.doc;
              });
            }
            this.status = 'waiting';
          }.bind(this)).catch(function(err) {
            this.status = 'waiting';
            console.log(err);
          }.bind(this));
        }.bind(this), 200);
      },

      _showNotification: function(text) {
        this.$.notification.text = text;
        this.$.notification.show();
      }
    });
  </script>
</dom-module>
