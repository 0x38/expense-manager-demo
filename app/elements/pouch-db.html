<link rel="import" href="../scripts/pouchdb.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<dom-module id="pouch-db">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <paper-toast id="notification"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'pouch-db',
      properties: {
        dbName: String,
        location: String,
        data: {
          type: Array,
          notify: true
        },
        paused: {
          type: Boolean,
          notify: true
        },
        attachments: {
          type: Object,
          notify: true
        },
        /**
         * Function that will get run on an empty DB to initialize it.
         */
        init: Object,
        _localDB: Object,
        _remoteDB: Object,
        _syncHandler: Object
      },

      ready: function() {
        this.attachments = {
          getAttachment: this._getAttachment.bind(this)
        };

      },

      attached: function() {
        this._localDB = new PouchDB(this.dbName, {
          size: 50
        });
        this.fire('db-initialized');
        if (this.location) {
          this._setupSync();
        }

        this._update();
      },

      _setupSync: function() {
        var _this = this;
        this._remoteDB = new PouchDB(this.location + '/' + this.dbName);

        this._syncHandler = this._localDB.sync(this._remoteDB, {
          live: true,
          retry: true
        }).on('change', function(change) {
          console.log(change);
          _this._update();
        }).on('paused', function() {
          _this.paused = true;
          _this.fire('sync-complete');
          console.log('Sync paused');
        }).on('active', function() {
          _this.paused = false;
          _this.fire('sync-started');
          console.log('Sync active');
        }).on('error', function(err) {
          console.log(err);
        });

        this._syncHandler.on('complete', function() {
          console.log('DB sync successfully shut down.');
        });
      },

      detached: function() {
        if (this._syncHandler) {
          this._syncHandler.cancel();
        }
      },

      save: function(doc) {
        var _this = this;
        if (!doc._id) {
          doc._id = new Date().toJSON();
        }

        this._localDB.put(doc)
          .catch(function(err) {
            if (err.name !== 'not_found') {
              throw err;
            }
            return _this.localDB.put(doc);
          }).then(function() {
            _this._update();
          });
      },

      remove: function(doc) {
        var _this = this;
        var db = this._localDB;

        db.get(doc._id)
          .then(function(_doc) {
            return db.remove(_doc);
          }).then(function() {
            _this._update();
          })
          .catch(function(err) {
            console.log(err);
          });
      },

      bulkDocs: function(docs, options) {
        var _this = this;
        this._localDB.bulkDocs(docs, options)
          .then(function() {
            _this._update();
          })
          .catch(function(err) {
            console.log(err);
          });
      },

      destroy: function() {
        this.bulkDocs(this.data.map(function(doc) {
          doc._deleted = true;
          return doc;
        }));
        this._localDB.destroy();
      },

      _getAttachment: function(docId, attachmentName) {
        return this._localDB.getAttachment(docId, attachmentName);
      },

      // Always updating entire array to keep demo code simple.
      // You should probably not do this in a real app (especially if you have a lot of data)
      _update: function() {
        // TODO: Debounce
        var _this = this;
        this._localDB.allDocs({
          // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
          include_docs: true,
          descending: true
        }).then(function(result) {
          if (result.rows && result.rows.length > 0) {
            _this.data = result.rows.map(function(row) {
              return row.doc;
            });
          } else if (_this.init && ((!_this.location) || (_this.location && _this._remoteDB))) {
            _this.bulkDocs(_this.init());
          }
        }).catch(function(err) {
          console.log(err);
        });
      },

      _showNotification: function(text) {
        this.$.notification.text = text;
        this.$.notification.show();
      }
    });
  </script>
</dom-module>