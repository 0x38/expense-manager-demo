<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="search-filters.html">

<dom-module id="expenses-list">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        @apply(--layout-vertical);
      }

      #add-button {
        position: absolute;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      #expenses {
        color: var(--primary-text-color);
        font-weight: 300;
      }

      #expenses ::content thead.vaadin-grid-header th,
      #expenses /deep/ thead.vaadin-grid-header th {
        background: var(--dark-primary-color);
        color: #ccc;
        font-size: 1.2em;
        font-weight: 400;
      }

      vaadin-grid ::content tr.vaadin-grid-row-stripe td,
      vaadin-grid /deep/ tr.vaadin-grid-row-stripe td {
        background: #F7F8F8;
      }

      #expenses ::content thead.vaadin-grid-header th.last-frozen,
      #expenses /deep/ thead.vaadin-grid-header th.last-frozen {
        border-right: 1px solid #2A3A42;
      }

      #expenses ::content .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after,
      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after {
        content: "\e7bc " attr(sort-order);
        font-family: Vaadin-Icons;
        font-size: 16px;
        speak: none;
        font-weight: normal;
        font-variant: normal;
        font-style: normal;
        text-transform: none;
        line-height: 1;
        -webkit-font-smoothing: antialiased;
        color: var(--default-primary-color);
      }

      #expenses ::content .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after,
      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after {
        content: "\e7c3 " attr(sort-order);
        font-family: Vaadin-Icons;
        font-size: 16px;
        speak: none;
        font-weight: normal;
        font-variant: normal;
        font-style: normal;
        text-transform: none;
        line-height: 1;
        -webkit-font-smoothing: antialiased;
        color: var(--default-primary-color);
      }
    </style>


    <search-filters filters="[[filters]]"></search-filters>

    <vaadin-grid class="flex" id="expenses" frozen-columns="1">
      <table>
        <colgroup>
          <col header-text="Date" name="date" sortable/>
          <col header-text="Merchant" name="merchant" sortable/>
          <col header-text="Total" name="total" sortable/>
          <col header-text="Status" name="status" sortable/>
          <col header-text="Comment" name="comment" sortable/>
        </colgroup>
      </table>
    </vaadin-grid>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
  </template>
  <script>
    Polymer({
      is: 'expenses-list',
      properties: {
        token: {
          type: String,
          notify: true,
          observer: '_setDataSource'
        },
        sortColumn: String,
        sortDirection: String,
        baseURL: String,
        filters: {
          type: Object,
          value: {},
          notify: true
        }
      },

      ready: function () {
        var grid = this.$.expenses;
        var _this = this;

        grid.columns[0].renderer = function (cell) {
          cell.element.innerHTML = moment(cell.data).format('MM/DD/YYYY');
        };

        grid.columns[2].renderer = function (cell) {
          cell.element.innerHTML = accounting.formatMoney(cell.data);
        };

        grid.addEventListener('sort-order-changed', function () {
          _this.sortColumn = grid.columns[grid.sortOrder[0].column].name;
          _this.sortDirection = grid.sortOrder[0].direction;
          grid.scrollToStart();
        });

        grid.addEventListener('select', function () {
          var selection = grid.selection.selected();
          if (selection.length === 1) {
            grid.getItem(selection[0], function (err, item) {
              _this.fire('edit-expense', {
                expense: item
              });
            });
          }
        });

      },

      _setDataSource: function () {
        if (this.token) {
          var _this = this;
          var grid = this.$.expenses;
          grid.datasource = function (req) {
            _this.fetchData(req.index, req.count).then(function (json) {
              req.success(json.result, json.metadata.totalcount);
            });
          };
        }
      },

      fetchData: function (index, count) {
        var _this = this;
        return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
              if (xhr.status === 200) {
                var json = JSON.parse(xhr.responseText);
                resolve(json);
              } else {
                reject();
              }
            }
          };
          xhr.open('GET', _this._getURLWithQuery(index, count), true);
          xhr.setRequestHeader('x-access-token', _this.token);
          xhr.send();
        });
      },

      update: function () {
        this.$.expenses.clearCache();
      },

      _getURLWithQuery: function (index, count) {
        var url = Config.baseURL + '/expenses?index=' + index + '&count=' + count;
        if (this.sortColumn && this.sortDirection) {
          url += '&sort=' + this.sortColumn + '&direction=' + this.sortDirection;
        }
        return url;
      },

      _showExpenseEditor: function () {
        this.fire('edit-expense');
      }
    });
  </script>
</dom-module>
