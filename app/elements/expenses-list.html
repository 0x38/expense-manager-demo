<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="expenses-list">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
      
      #add-button {
        position: absolute;
        right: 60px;
        top: -28px;
        z-index: 2;
      }
      
      #expenses {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>

    <vaadin-grid id="expenses">
      <table>
        <colgroup>
          <col header-text="Merchant" name="merchant" sortable/>
          <col header-text="Total" name="total" sortable/>
          <col header-text="Date" name="date" sortable/>
          <col header-text="Status" name="status" sortable/>
        </colgroup>
      </table>
    </vaadin-grid>
  </template>
  <script src="../bower_components/accounting/accounting.min.js" charset="utf-8"></script>
  <script src="../bower_components/moment/moment.js" charset="utf-8"></script>
  <script>
    Polymer({
      is: 'expenses-list',
      properties: {
        token: String,
        sortColumn: String,
        sortDirection: String,
        baseURL: String
      },

      ready: function() {
        var grid = this.$.expenses;
        var _this = this;

        grid.columns[1].renderer = function(cell) {
          cell.element.innerHTML = accounting.formatMoney(cell.data);
        };
        grid.columns[2].renderer = function(cell) {
          cell.element.innerHTML = moment(cell.data).format('MM/DD/YYYY');
        };

        grid.addEventListener('sort-order-changed', function() {
          _this.sortColumn = grid.columns[grid.sortOrder[0].column].name;
          _this.sortDirection = grid.sortOrder[0].direction;
          grid.scrollToStart();
        });
        grid.datasource = function(req) {
          _this.fetchData(req.index, req.count).then(function(json) {
            req.success(json.result, json.metadata.totalcount);
          });
        };

        grid.addEventListener('select', function() {
          var selection = grid.selection.selected();
          if (selection.length === 1) {
            grid.getItem(selection[0], function(err, item) {
              _this.fire('edit-expense', {
                expense: item
              });
            });
          }
        });

      },

      fetchData: function(index, count) {
        var _this = this;
        return new Promise(function(resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
              if (xhr.status === 200) {
                var json = JSON.parse(xhr.responseText);
                resolve(json);
              } else {
                reject();
              }
            }
          };
          xhr.open('GET', _this._getURLWithQuery(index, count), true);
          xhr.setRequestHeader('x-access-token', _this.token);
          xhr.send();
        });
      },

      update: function() {
        this.$.expenses.data.clearCache();
      },

      _getURLWithQuery: function(index, count) {
        var url = Config.baseURL + '/expenses?index=' + index + '&count=' + count;
        if (this.sortColumn && this.sortDirection) {
          url += '&sort=' + this.sortColumn + '&direction=' + this.sortDirection;
        }
        return url;
      },

      _showExpenseEditor: function() {
        this.fire('edit-expense');
      }
    });
  </script>
</dom-module>