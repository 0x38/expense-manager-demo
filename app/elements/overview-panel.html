<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-charts/vaadin-bar-chart.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="overview-panel">
  <template>
    <style>
      :host {
        display: block;
        background: var(--light-primary-color);
      }

      .total {
        background: var(--default-primary-color);
        color: var(--text-primary-color);
        box-sizing: border-box;
        width: 100%;
        padding: 20px;
      }

      .total .sum {
        font-size: 24px;
      }

      .chart-title {
        font-weight: 300;
        text-align: center;
      }

      @media (max-width: 600px) {
        .chart {
          display: none;
        }
      }
    </style>

    <div class="layout vertical" id="container">
      <div class="layout vertical center-center flex">
        <div class="total layout vertical center-center">
          <div>Total</div>
          <div class="sum">[[totalOwed]]</div>
        </div>
      </div>
      <div class="chart">
        <h2 class="chart-title">Last 12 months</h2>
        <vaadin-bar-chart>
          <title>Last 12 months</title>
          <chart background-color="transparent"></chart>
          <exporting enabled="false"></exporting>
          <x-axis categories="[[categories]]">
            <title>Month</title>
          </x-axis>
          <data-series name="$" data="[[seriesData]]">
            <color>#80CBC4</color>
          </data-series>
        </vaadin-bar-chart>
      </div>
    </div>

    <iron-ajax id="ajax" url="[[url]]" handle-as="json" headers="[[requestHeader]]"
               last-response="{{overviewData}}"></iron-ajax>

  </template>
  <script>
    Polymer({
      is: 'overview-panel',
      properties: {
        categories: {
          type: String,
          value: '',
          notify: true
        },
        seriesData: {
          type: Array,
          value: [],
          notify: true
        },
        overviewData: {
          type: Object,
          observer: '_dataUpdated'
        },
        requestHeader: {
          type: Object,
          computed: '_createRequestHeader(token)'
        },
        url: String,
        totalOwed: String,
        token: {
          type: String,
          observer: 'update'
        }
      },


      update: function () {
        if (this.token) {
          this.$.ajax.generateRequest();
        }
      },

      ready: function () {
        this.url = Config.baseURL + '/expenses/overview';
      },

      _dataUpdated: function () {
        if (this.overviewData) {
          this.totalOwed = accounting.formatMoney(this.overviewData.totalOwed);
          this.categories = this.overviewData.history.map(function (m) {
            return m.month + '/' + m.year;
          }).join(', ');
          this.seriesData = this.overviewData.history.map(function (m) {
            return m.total;
          });
        }
      },

      _createRequestHeader: function (token) {
        return {
          'x-access-token': token
        };
      }
    });
  </script>
</dom-module>
