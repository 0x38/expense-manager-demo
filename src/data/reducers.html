<script src="../../node_modules/redux/dist/redux.min.js"></script>
<script src="../moment.min.js"></script>

<script>
  (() => {
    // No-dependency UUID generator https://gist.github.com/jed/982883, good enough for this demo
    const uuid = () => ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, a => (a ^ Math.random() * 16 >> a / 4).toString(16));


    // TODO: get from localstorage, combine with initial

    let initialState = {
      authenticated: false,
      expenses: generateDemoExpenses(100),
      selectedExpense: undefined,
      filters: {
        status: ['new', 'in_progress', 'reimbursed']
      },
      uiState: {
        infoDialogVisible: false,
        filtersVisible: false
      },
    };

    const savedState = localStorage.getItem('ExpenseManagerState');
    if (savedState) {
      initialState = Object.assign({}, initialState, JSON.parse(savedState));
    }


    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.rootReducer = function (state = initialState, action) {
      switch (action.type) {
        case 'LOGIN':
          return Object.assign({}, state, { authenticated: true });

        case 'LOGOUT':
          return Object.assign({}, state, { authenticated: false });

        case 'SHOW_INFO_DIALOG':
          return Object.assign({}, state, { uiState: Object.assign({}, state.uiState, { infoDialogVisible: true }) });

        case 'HIDE_INFO_DIALOG':
          return Object.assign({}, state, { uiState: Object.assign({}, state.uiState, { infoDialogVisible: false }) });

        case 'EDIT_EXPENSE':
          return Object.assign({}, state, { selectedExpense: action.expense });

        case 'UPDATE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.map(e => e.id === action.expense.id ? action.expense : e),
            selectedExpense: undefined
          });

        case 'ADD_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.concat(action.expense),
            selectedExpense: undefined
          });

        case 'DELETE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.filter(e => e.id !== action.expense.id),
            selectedExpense: undefined
          });

        case 'CANCEL_EDIT':
          return Object.assign({}, state, { selectedExpense: undefined });

        case 'TOGGLE_FILTERS':
          return Object.assign({}, state, { uiState: Object.assign({}, state.uiState, { filtersVisible: !state.uiState.filtersVisible }) });

        case 'HIDE_FILTERS':
          return Object.assign({}, state, { uiState: Object.assign({}, state.uiState, { filtersVisible: false }) });

        case 'FILTERS_UPDATED':
          return Object.assign({}, state, { filters: action.filters });

        case 'CLEAR_FILTERS':
          return Object.assign({}, state, {
            filters: { status: ['new', 'in_progress', 'reimbursed'] }
          });

        default:
          return state;
      }
    };

    function getRandomPrice() {
      const price = Math.random() * (Math.random() * 3) * 300 + 10;
      return parseFloat(price.toFixed(2));
    }

    function generateDemoExpenses(num) {
      let date = moment();
      const expenses = [];
      for (let i = 0; i < num; i++) {
        date = date.subtract(Math.floor(Math.random() * 168) + 1, 'hours');
        var status = 'new';
        if (i > 10) {
          status = 'reimbursed';
        } else if (i > 5) {
          status = 'in_progress';
        }
        expenses.push({
          id: uuid(),
          date: date.format('YYYY-MM-DD'),
          merchant: [
            'Office supplies', 'Electronics', 'Rental car', 'Airline',
            'Hotel', 'Restaurant', 'Taxi', 'Ride sharing', 'Fast food',
            'Parking', 'Breakfast', 'Shuttle'
          ]
          [Math.floor(Math.random() * 12)],
          total: getRandomPrice(),
          status: status,
          receipt: status === 'new' ? '' : '/images/default-receipt.png',
          comment: 'Expense from my business trip.'
        });
      }
      return expenses;
    }
  })();

</script>
