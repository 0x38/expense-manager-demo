<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="moment-js.html">

<dom-module id="expenses-list">
  <template>
    <style>
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      #add-button {
        position: absolute;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      @media (max-width: 1124px) {
        #add-button {
          bottom: -28px;
        }
      }

      @media (min-width: 1125px) {
        #add-button {
          bottom: auto;
          top: -29px;
        }
      }

      @media (max-width: 900px) {
        #add-button {
          bottom: 32px;
        }
      }

      #expenses {
        flex: 1;
        color: var(--primary-text-color);
      }

      @media (max-width: 1124px) {
        #expenses {
          font-size: 15px;
        }
      }

      #expenses /deep/ thead.vaadin-grid-header {
        box-shadow: 0 -9px 2px 10px rgba(0, 0, 0, 0.1), 0 -8px 3px 10px rgba(204, 204, 204, 0.20);
      }

      #expenses th {
        text-transform: uppercase;
        font-size: 12px;
        font-weight: 500;
        color: var(--primary-text-color);
      }

      #expenses  .total {
        flex-direction: row-reverse;
      }

      #expenses  .status-new {
        color: var(--accent-color);
        font-weight: 500;
      }

      #expenses .status-in_progress {
        font-weight: 500;
        font-style: italic;
        text-transform: capitalize;
      }

      #expenses  .comment {
        position: relative;
      }

      #expenses .comment span {
        width: 100%;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        padding-right: 35px;
        box-sizing: border-box;
      }

      #expenses vaadin-grid-column > div {
        padding: 16px;
        cursor: pointer;
      }

    </style>


    <vaadin-grid id="expenses" frozen-columns="1" on-cell-click="_cellClick" size="50">
      <vaadin-grid-column width="120px">
        <template is="header">Date</template>
  <template>[[_formatDate(item.date)]]</template>
  </vaadin-grid-column>
  <vaadin-grid-column width="145px">
    <template is="header">Merchant</template>
    <template>[[item.merchant]]</template>
  </vaadin-grid-column>
  <vaadin-grid-column width="90px">
    <template is="header">Total</template>
    <template><span class="total">[[_formatMoney(item.total)]]</span></template>
  </vaadin-grid-column>
  <vaadin-grid-column width="120px">
    <template is="header">Status</template>
    <template><span class$="[[_getStatusClass(item.status)]]">[[item.status]]</span></template>
  </vaadin-grid-column>
  <vaadin-grid-column width="260px" flex="2">
    <template is="header">Comment</template>
    <template><span class="comment">[[item.comment]]</span></template>
  </vaadin-grid-column>
  </vaadin-grid>
  <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>

  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'expenses-list',

        properties: {
          expenses: Array,
          sortColumn: String,
          sortDirection: String,
          filters: Object
        },

        observers: [
          '_update(filters, expenses)',
          '_filtersChanged(filters.*)',
          '_update(expenses.*)',
          '_update(sortColumn)',
          '_update(sortDirection)'
        ],

        _formatDate: function(date) {
          return moment(date).format('MM/DD/YYYY');
        },

        _formatMoney: function(sum) {
          return '$' + sum.toFixed(2);
        },

        _getStatusClass: function(status) {
          return 'status-' + status.replace(/ /g, '-').toLowerCase();
        },

        _showExpenseEditor: function() {
          this.fire('edit-expense', {});
        },

        _cellClick: function(e) {
          console.log('Cell clicked!');
          this.fire('edit-expense', e.detail.model.item);
        },

        _filtersChanged: function() {
          if (this.$.expenses.items) {
            this.debounce('_filtersChanged', function() {
              this._update();
            }, 300);
          }
        },

        _update: function() {
          if (!this.filters) {
            return;
          }
          var grid = this.$.expenses;
          var merchant = this.filters.merchant;
          var min = this.filters.min;
          var max = this.filters.max;
          var status = this.filters.status;
          var start = this.filters.start;
          var end = this.filters.end;
          var sort = 'date';
          var direction = 'desc';
          if (grid.sortOrder && grid.sortOrder[0]) {
            sort = grid.columns[grid.sortOrder[0].column].name;
            direction = grid.sortOrder[0].direction;
          }

          // Filter
          var result = this.expenses
            .filter(function(expense) {
              return !(merchant && expense.merchant
                .toUpperCase().indexOf(merchant.toUpperCase()) < 0);
            })
            .filter(function(expense) {
              return !(min && expense.total < min);
            })
            .filter(function(expense) {
              return !(max && expense.total > max);
            })
            .filter(function(expense) {
              if (status && status.length > 0) {
                return status.indexOf(expense.status) >= 0;
              } else {
                return false;
              }
            })
            .filter(function(expense) {
              if (start) {
                var startDate = moment(start);
                return !!(startDate.isValid() && moment(expense.date).isAfter(startDate));
              } else {
                return true;
              }
            })
            .filter(function(expense) {
              if (end) {
                var endDate = moment(end);
                return !!(endDate.isValid() && moment(expense.date).isBefore(endDate));
              } else {
                return true;
              }
            });

          // Sort
          if (sort) {
            var sortProperty = sort;
            var sortDirection = direction || 'desc';
            var datePattern = /^[0-9]{2}\/[0-9]{2}\/[0-9]{4}$/;
            result.sort(function(a, b) {
              var res;
              if (!isNaN(a[sortProperty])) {
                res = parseInt(a[sortProperty], 10) - parseInt(b[sortProperty], 10);
              } else if (datePattern.test(a[sortProperty])) {
                // Sort dates with moment.js.
                res = moment(a[sortProperty]).isBefore(moment(b[sortProperty])) ? 1 : -1;
              } else {
                // Let's pretend everything that's not a number or date is a string.
                res = a[sortProperty].localeCompare(b[sortProperty]);
              }

              if ('desc' === sortDirection) {
                res *= -1;
              }
              return res;
            });
          }

          if (result.length > 0) {
            grid.dataSource = function(opts, callback) {
              var startIndex = opts.page * opts.pageSize;
              var endIndex = Math.min(startIndex + opts.pageSize, result.length);
              callback(result.slice(startIndex, endIndex));
            };
            if (grid.size !== result.length) {
              grid.size = result.length;
            } else {
              grid.clearCache();
            }
          }
        }
      });
    })();
  </script>
</dom-module>
