<html><head><script src="../pouchdb/dist/pouchdb.js"></script><link rel="import" href="../polymer/polymer.html"><script>Polymer({is:'vaadin-pouchdb',properties:{dbname:{type:String,observer:'_dbnameChanged'},live:{type:Boolean,value:!0},remote:{type:String,value:null,observer:'_remoteChanged'},index:{type:String,observer:'_indexChanged'},descending:{type:Boolean},attachments:{type:Object,notify:!0},data:{type:Array,notify:!0,value:function(){return[]}},status:{type:String,notify:!0}},_indexes:[],_db:null,_remotedb:null,_oldname:null,_synchandler:null,_changesHandler:null,_query:null,getAttachment:function(b,c){return this._db.getAttachment(b,c)},_dbnameChanged:function(){this.cancelChanges(),this.close(),this.dbname&&(this._db=new PouchDB(this.dbname))},_remoteChanged:function(){this.cancelSync(),this.remote&&this.sync().on('change',function(b){b&&1<(b.changes&&b.changes.array||b.change&&b.change.docs).length&&(this.cancelSync(),this.sync())}.bind(this))},close:function(b){this._db&&(b?this._db.destroy():this._db.close(),this._db=null)},then:function(){return this._db},info:function(b,c,d){return this._db.changes({since:b.update_seq,onError:d,onChange:c,continuous:!0})},post:function(b){return this._db.post(b)},put:function(b){return this._db.put(b)},save:function(b){return b._id?this._db.put(b):this._db.post(b)},remove:function(b){return this._db.remove(b)},changes:function(b,c){return this._changesHandler=this._db.changes(c||{since:'now',live:!0,include_docs:!0}).on('change',function(d){b(d.doc)}),this._changesHandler},allDocs:function(){return this.query()},query:function(b,c){return c=c||{include_docs:!0,descending:this.descending},b=b||this._indexes&&this._indexes[0],this.status='querying',(this._query=this._query||(b?this._db.query(b,c):this._db.allDocs(c))).then(function(d){d.rows&&(this.data=d.rows.map(function(e){return e.doc})),this.status=void 0,this._query=null}.bind(this))},_indexChanged:function(){this._indexes=this.index&&this.index.split(/[ *, *]/)||[];for(var b=0;b<this._indexes.length;b++)this.createIndex(this._indexes[b])},createIndex:function(b){var c={};c[b]={map:'function(doc){if(doc.'+b+') emit(doc.'+b+')}'};this._db.put({_id:'_design/'+b,views:c}).then(function(){return this._db.query(b,{stale:'update_after'})}).catch(function(e){if('conflict'!=e.name)throw e})},sync:function(b,c,d){if(!this.remote||this._synchandler)return this._synchandler;var e=d||{timeout:0};this.live&&(e.live=e.retry=!0);var f=this._db.sync(this.remote,e);return f.on('paused',function(){this.status=void 0}.bind(this)).on('active',function(){this.status='syncing'}.bind(this)),b&&f.on('change',b).on('paused',b).on('active',b),c&&f.on('error',c),this._synchandler=this.live?f:null,f},cancelSync:function(){this._synchandler&&(this._synchandler.cancel(),this._synchandler=null)},cancelChanges:function(){this._changesHandler&&(this._changesHandler.cancel(),this._changesHandler=null)}});</script><script>Polymer.Vaadin=Polymer.Vaadin||{},Polymer.Vaadin.DbPromise={then:function(){},on:function(){}},Polymer.Vaadin.DbResp={properties:{rows:{type:Array},total_rows:{type:Number},offset:{type:Number}}},Polymer.Vaadin.DbRow={properties:{doc:{type:Object},_id:{type:String}}},Polymer.Vaadin.Conf={properties:{key:{type:String},keys:{type:Array},startkey:{type:String},endkey:{type:String},limit:{type:Number},descending:{type:Boolean},skip:{type:Number},group:{type:Number},group_level:{type:Number},reduce:{type:Boolean},include_docs:{type:Boolean},inclusive_end:{type:Boolean},update_seq:{type:Boolean}}};</script></head><body></body></html>