<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../iron-flex-layout/iron-flex-layout.html"><link rel="import" href="../paper-styles/typography.html"><link rel="import" href="../paper-ripple/paper-ripple.html"><link rel="import" href="../paper-button/paper-button.html"><link rel="import" href="vaadin-upload-icons.html"><link rel="import" href="vaadin-upload-file.html"></head><body><dom-module id="vaadin-upload"><template><style>:host{@apply (--layout-vertical);display:block;position:relative;text-align:left;}:host(:not([nodrop])){border:1px dashed;border-color:var(--divider-color, #666);border-radius:3px;overflow:hidden;padding:16px;}:host([dragover-valid]){border-color:var(--primary-color, #00B4F0);}:host::before{@apply (--layout-fit);content:'';display:none;z-index:10;}:host([dragover])::before{display:block;}#dragRipple{color:var(--light-primary-color, #7CD8F7);@apply (--vaadin-upload-drag-ripple);}#dropLabel{@apply (--layout-flex);@apply (--paper-font-body2);position:relative;padding:.43em .57em;margin:0 .29em;color:var(--disabled-text-color, #b3b3b3);@apply (--vaadin-upload-drop-label);}:host([dragover-valid]) #dropLabel,
      :host([dragover-valid]) ::content .drop-label{color:var(--primary-color, #00B4F0);@apply (--vaadin-upload-drop-label-dragover);}#dropLabel ::content iron-icon{margin-right:.25em;@apply (--vaadin-upload-drop-label-icon);}#fileList{position:relative;@apply (--vaadin-upload-file-list);}#buttons{@apply (--layout-horizontal);position:relative;@apply (--vaadin-upload-buttons);}#buttonsPrimary{@apply (--layout-horizontal);@apply (--layout-flex);@apply (--layout-start);margin-left:-.29em;@apply (--vaadin-upload-buttons-primary);}#addFiles{@apply (--paper-font-button);padding:.43em .57em;background:var(--primary-color, #00B4F0);color:var(--primary-font-color, #FFF);@apply (--vaadin-upload-button-add);}#addFiles[disabled]{background:var(--divider-color, #e0e0e0);color:var(--disabled-text-color, gray);@apply (--vaadin-upload-button-add-disabled);}</style><div id="buttons"><div id="buttonsPrimary"><paper-button id="addFiles" on-tap="_onAddFilesClick" disabled="[[_maxFilesAdded(maxFiles, files.length)]]">[[_i18nPlural(maxFiles, i18n.addFiles, i18n.addFiles.*)]]</paper-button><div id="dropLabel" hidden$="[[nodrop]]"><content select=".drop-label"><iron-icon icon="vaadin-upload:file-upload"></iron-icon>[[_i18nPlural(maxFiles, i18n.dropFiles, i18n.dropFiles.*)]]</content></div></div></div><content select=".file-list"><div id="fileList"><template is="dom-repeat" items="[[files]]" as="file"><vaadin-upload-file file="[[file]]"></vaadin-upload-file></template></div></content><content></content><input type="file" id="fileInput" on-change="_onFileInputChange" hidden="" accept$="{{accept}}" multiple$="[[_isMultiple(maxFiles)]]"><paper-ripple id="dragRipple" noink=""></paper-ripple></template></dom-module><script>Polymer({is:'vaadin-upload',properties:{nodrop:{type:Boolean,reflectToAttribute:!0,value:function(){try{return!!document.createEvent('TouchEvent')}catch(b){return!1}}},target:{type:String,value:''},method:{type:String,value:'POST'},headers:{type:Object,value:{}},timeout:{type:Number,value:0},_dragover:{type:Boolean,value:!1,observer:'_dragoverChanged'},files:{type:Array,notify:!0,value:function(){return[]}},maxFiles:{type:Number,value:Infinity},accept:{type:String,value:''},maxFileSize:{type:Number,value:Infinity},_dragoverValid:{type:Boolean,value:!1,observer:'_dragoverValidChanged'},formDataName:{type:String,value:'file'},i18n:{type:Object,value:function(){return{dropFiles:{one:'Drop file here...',many:'Drop files here...'},addFiles:{one:'Select File',many:'Upload Files'},cancel:'Cancel',error:{tooManyFiles:'Too Many Files.',fileIsTooBig:'File is Too Big.',incorrectFileType:'Incorrect File Type.'},uploading:{status:{connecting:'Connecting...',stalled:'Stalled.',processing:'Processing File...'},remainingTime:{prefix:'remaining time: ',unknown:'unknown remaining time'},error:{serverUnavailable:'Server Unavailable',unexpectedServerError:'Unexpected Server Error',forbidden:'Forbidden'}},units:{size:['B','kB','MB','GB','TB','PB','EB','ZB','YB']}}}}},listeners:{dragover:'_onDragover',dragleave:'_onDragleave',drop:'_onDrop','file-retry':'_onFileRetry','file-abort':'_onFileAbort','file-remove':'_onFileRemove'},_formatSize:function(b){if('function'==typeof this.i18n.formatSize)return this.i18n.formatSize(b);var c=this.i18n.units.sizeBase||1e3,d=~~(Math.log(b)/Math.log(c)),f=Math.max(0,Math.min(3,d-1)),g=parseFloat((b/Math.pow(c,d)).toFixed(f));return g+' '+this.i18n.units.size[d]},_splitTimeByUnits:function(b){for(var c=[60,60,24,Infinity],d=[0],f=0;f<c.length&&0<b;f++)d[f]=b%c[f],b=Math.floor(b/c[f]);return d},_formatTime:function(b,c){if('function'==typeof this.i18n.formatTime)return this.i18n.formatTime(b,c);for(;3>c.length;)c.push(0);return c.reverse().map(function(d){return(10>d?'0':'')+d}).join(':')},_formatFileProgress:function(b){return b.totalStr+': '+b.progress+'% ('+(0<b.loaded?this.i18n.uploading.remainingTime.prefix+b.remainingStr:this.i18n.uploading.remainingTime.unknown)+')'},_maxFilesAdded:function(){return 0<=this.maxFiles&&this.files.length>=this.maxFiles},_dragRippleAction:function(b,c){var d={detail:{x:c.clientX,y:c.clientY}};if('down'==b){this.$.dragRipple.downAction(d);var f=this.$.dragRipple.ripples[this.$.dragRipple.ripples.length-1];f.hasOwnProperty('radius')||Object.defineProperty(f,'radius',{get:function(){var h=this.containerMetrics.width*this.containerMetrics.width,j=this.containerMetrics.height*this.containerMetrics.height,k=1.1*Math.sqrt(h+j)+5,m=this.mouseInteractionSeconds/(0.9+0.2*(k/300)),n=k*(1-Math.pow(80,-m));return Math.abs(n)}})}else this.$.dragRipple.upAction(d)},_onDragover:function(b){b.preventDefault(),this.nodrop||this._dragover||(this._dragoverValid=!this._maxFilesAdded(),this._dragoverValid&&this._dragRippleAction('down',b),this._dragover=!0),b.dataTransfer.dropEffect=!this._dragoverValid||this.nodrop?'none':'copy'},_onDragleave:function(b){Polymer.dom(b).rootTarget===this&&(b.preventDefault(),this._dragover&&!this.nodrop&&(this._dragRippleAction('up',b),this._dragover=this._dragoverValid=!1))},_onDrop:function(b){this.nodrop||(b.preventDefault(),this._dragRippleAction('up',b),this._dragover=this._dragoverValid=!1,this._dragRippleAction('upAction',b),this._addFiles(b.dataTransfer.files))},_createXhr:function(){return new XMLHttpRequest},_configureXhr:function(b){if('string'==typeof this.headers)try{this.headers=JSON.parse(this.headers)}catch(d){this.headers=void 0}for(var c in this.headers)b.setRequestHeader(c,this.headers[c]);this.timeout&&(b.timeout=this.timeout)},_setStatus:function(b,c,d,f){b.elapsed=f,b.elapsedStr=this._formatTime(b.elapsed,this._splitTimeByUnits(b.elapsed)),b.remaining=Math.ceil(f*(c/d-1)),b.remainingStr=this._formatTime(b.remaining,this._splitTimeByUnits(b.remaining)),b.speed=~~(c/f/1024),b.totalStr=this._formatSize(c),b.loadedStr=this._formatSize(d),b.status=this._formatFileProgress(b)},_uploadFile:function(b){if(!b.uploading){var f,g,c=Date.now(),d=b.xhr=this._createXhr(b);d.upload.onprogress=function(k){clearTimeout(f),g=Date.now();var l=(g-c)/1e3,m=k.loaded,n=k.total,o=~~(100*(m/n));b.loaded=m,b.progress=o,b.indeterminate=0>=m||m>=n,!0,b.error?b.indeterminate=b.status=void 0:!b.abort&&(100>o?(this._setStatus(b,n,m,l,o),f=setTimeout(function(){b.status=this.i18n.uploading.status.stalled,this._notifyFileChanges(b)}.bind(this),2e3)):(b.loadedStr=b.totalStr,b.status=this.i18n.uploading.status.processing,b.uploading=!1)),this._notifyFileChanges(b),this.fire('upload-progress',{file:b,xhr:d})}.bind(this),d.onreadystatechange=function(){if(4==d.readyState){if(clearTimeout(f),b.indeterminate=b.uploading=!1,b.abort)return void this._notifyFileChanges(b);b.status='';var k=this.fire('upload-response',{file:b,xhr:d},{cancelable:!0});if(k.defaultPrevented)return;0===d.status?b.error=this.i18n.uploading.error.serverUnavailable:500<=d.status?b.error=this.i18n.uploading.error.unexpectedServerError:400<=d.status&&(b.error=this.i18n.uploading.error.forbidden),b.complete=!b.error,this.fire('upload-'+(b.error?'error':'success'),{file:b,xhr:d}),this._notifyFileChanges(b)}}.bind(this);var h=new FormData;b.uploadTarget=this.target||'',b.formDataName=this.formDataName;var j=this.fire('upload-before',{file:b,xhr:d},{cancelable:!0});j.defaultPrevented||(h.append(b.formDataName,b,b.name),d.open(this.method,b.uploadTarget,!0),this._configureXhr(d),b.status=this.i18n.uploading.status.connecting,b.uploading=b.indeterminate=!0,b.complete=b.abort=b.error=!1,d.upload.onloadstart=function(){this.fire('upload-start',{file:b,xhr:d}),this._notifyFileChanges(b)}.bind(this),j=this.fire('upload-request',{file:b,xhr:d,formData:h},{cancelable:!0}),!j.defaultPrevented&&d.send(h))}},_retryFileUpload:function(b){var c=this.fire('upload-retry',{file:b,xhr:b.xhr},{cancelable:!0});c.defaultPrevented||this.async(this._uploadFile.bind(this,b))},_abortFileUpload:function(b){var c=this.fire('upload-abort',{file:b,xhr:b.xhr},{cancelable:!0});c.defaultPrevented||(b.abort=!0,b.xhr&&b.xhr.abort(),this._notifyFileChanges(b))},_notifyFileChanges:function(b){var c='files.'+this.files.indexOf(b)+'.';for(var d in b)b.hasOwnProperty(d)&&this.notifyPath(c+d,b[d])},_addFiles:function(b){Array.prototype.forEach.call(b,this._addFile.bind(this))},_addFile:function(b){if(this._maxFilesAdded())return void this.fire('file-reject',{file:b,error:this.i18n.error.tooManyFiles});if(0<=this.maxFileSize&&b.size>this.maxFileSize)return void this.fire('file-reject',{file:b,error:this.i18n.error.fileIsTooBig});var c=b.name.match(/\.[^\.]*$|$/)[0],d=new RegExp('^('+this.accept.replace(/[, ]+/g,'|').replace(/\/\*/g,'/.*')+')$','i');return this.accept&&!(d.test(b.type)||d.test(c))?void this.fire('file-reject',{file:b,error:this.i18n.error.incorrectFileType}):void(b.loaded=0,this.unshift('files',b),this._uploadFile(b))},_removeFile:function(b){this.splice('files',this.files.indexOf(b),1)},_onAddFilesClick:function(){Polymer.Gestures.resetMouseCanceller&&Polymer.Gestures.resetMouseCanceller(),this.$.fileInput.value='',this.$.fileInput.click()},_onFileInputChange:function(b){this._addFiles(b.target.files)},_onFileRetry:function(b){this._retryFileUpload(b.detail.file)},_onFileAbort:function(b){this._abortFileUpload(b.detail.file)},_onFileRemove:function(b){b.stopPropagation(),this._removeFile(b.detail.file)},_dragoverChanged:function(b){this.toggleAttribute('dragover',b)},_dragoverValidChanged:function(b){this.toggleAttribute('dragover-valid',b)},_i18nPlural:function(b,c){return 1==b?c.one:c.many},_isMultiple:function(){return 1!=this.maxFiles}});</script></body></html>